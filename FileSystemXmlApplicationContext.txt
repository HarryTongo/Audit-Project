# ğŸ“ FileSystemXmlApplicationContext é“¾è·¯ç¬”è®°

------

## 1ï¸âƒ£ èƒŒæ™¯æ¦‚è¿°

- **ä½œç”¨**ï¼šSpring æä¾›çš„ `FileSystemXmlApplicationContext` ç”¨äºä»æ–‡ä»¶ç³»ç»Ÿæˆ– URL åŠ è½½ XML é…ç½®æ–‡ä»¶ï¼Œå¹¶æ ¹æ®å…¶ä¸­ `<bean>` å®šä¹‰åˆ›å»º Beanã€‚
- **é£é™©ç‚¹**ï¼šå¦‚æœæ”»å‡»è€…å¯ä»¥æ§åˆ¶ `configLocations`ï¼ŒSpring ä¼šè§£æè¿œç¨‹ XML å¹¶å®ä¾‹åŒ–ä»»æ„ç±»å¯¹è±¡ï¼Œå¯èƒ½è§¦å‘ RCEã€‚

------

## 2ï¸âƒ£ ç±»ç»§æ‰¿å…³ç³»

```markdown
FileSystemXmlApplicationContext
   â†³ AbstractXmlApplicationContext
       â†³ AbstractRefreshableConfigApplicationContext
           â†³ AbstractRefreshableApplicationContext
               â†³ AbstractApplicationContext
                   â†³ DefaultResourceLoader
```

- `FileSystemXmlApplicationContext`ï¼šå…¥å£ç±»ï¼Œä¼ å…¥ `configLocations` å¹¶è°ƒç”¨ `refresh()`ã€‚
- `AbstractXmlApplicationContext`ï¼šå®šä¹‰ XML åŠ è½½æµç¨‹ï¼Œè°ƒç”¨ `loadBeanDefinitions(XmlBeanDefinitionReader)`ã€‚
- `AbstractApplicationContext`ï¼šå®ç° `ResourcePatternResolver`ï¼Œç®¡ç† `resourcePatternResolver`ã€‚
- `DefaultResourceLoader`ï¼šè´Ÿè´£æ ¹æ®è·¯å¾„/URLåˆ›å»º `Resource` å¯¹è±¡ã€‚

> **æ ¸å¿ƒç‚¹**ï¼š`FileSystemXmlApplicationContext` å®ä¾‹æœ¬èº«ç»§æ‰¿äº† `DefaultResourceLoader`ï¼Œæ‰€ä»¥å®ƒèƒ½è¢« `XmlBeanDefinitionReader` å½“ä½œ `ResourceLoader` ä½¿ç”¨ã€‚

------

## 3ï¸âƒ£ æ ¸å¿ƒè°ƒç”¨é“¾

### 3.1 æ„é€ å‡½æ•°å…¥å£

```java
public FileSystemXmlApplicationContext(String[] configLocations, boolean refresh, @Nullable ApplicationContext parent) {
    super(parent);
    this.setConfigLocations(configLocations); // ä¿å­˜è·¯å¾„/URL
    if (refresh) {
        this.refresh(); // è§¦å‘æ•´ä¸ªå®¹å™¨åˆå§‹åŒ–
    }
}
```

- `setConfigLocations`ï¼šçˆ¶ç±» `AbstractRefreshableConfigApplicationContext` æ–¹æ³•ï¼Œå°† `configLocations` ä¿å­˜åˆ°æˆå‘˜å˜é‡ã€‚
- `refresh()`ï¼šçˆ¶ç±» `AbstractApplicationContext` æ–¹æ³•ï¼Œåˆå§‹åŒ– BeanFactory å¹¶åŠ è½½ BeanDefinitionã€‚

------

### 3.2 refresh() è°ƒç”¨ loadBeanDefinitions

åœ¨ `AbstractApplicationContext.refresh()` ä¸­ä¼šæ‰§è¡Œï¼š

1. ###### åˆ›å»º BeanFactory

```java
ConfigurableListableBeanFactory beanFactory = this.obtainFreshBeanFactory();
	â†“
protected ConfigurableListableBeanFactory obtainFreshBeanFactory() {
    this.refreshBeanFactory();
    return this.getBeanFactory();
}
	â†“
protected abstract void refreshBeanFactory() throws BeansException, IllegalStateException;
	â†“
protected final void refreshBeanFactory() throws BeansException {
    if (this.hasBeanFactory()) {
        this.destroyBeans();
        this.closeBeanFactory();
    }

    try {
        DefaultListableBeanFactory beanFactory = this.createBeanFactory();
        beanFactory.setSerializationId(this.getId());
        this.customizeBeanFactory(beanFactory);
        this.loadBeanDefinitions(beanFactory);
        this.beanFactory = beanFactory;
    } catch (IOException ex) {
        throw new ApplicationContextException("I/O error parsing bean definition source for " + this.getDisplayName(), ex);
    }
}

```

1. ###### è°ƒç”¨ï¼š

```java
this.loadBeanDefinitions(beanFactory);
```

- å¯¹åº” `AbstractXmlApplicationContext.loadBeanDefinitions(XmlBeanDefinitionReader)`ï¼š

```java
protected void loadBeanDefinitions(XmlBeanDefinitionReader reader) throws BeansException, IOException {
    Resource[] configResources = this.getConfigResources();
    if (configResources != null) {
        reader.loadBeanDefinitions(configResources); // Resource[] è°ƒç”¨å­ç±»å®ç°
    }

    String[] configLocations = this.getConfigLocations();
    if (configLocations != null) {
        reader.loadBeanDefinitions(configLocations); // String[] è°ƒç”¨çˆ¶ç±» AbstractBeanDefinitionReader
    }
}
```

------

### 3.3 AbstractBeanDefinitionReader å¤„ç†å­—ç¬¦ä¸²è·¯å¾„

```java
public int loadBeanDefinitions(String location, @Nullable Set<Resource> actualResources) throws BeanDefinitionStoreException {
    ResourceLoader resourceLoader = this.getResourceLoader();  // â† this æ˜¯ FileSystemXmlApplicationContext
    if (resourceLoader == null) throw new BeanDefinitionStoreException(...);

    if (resourceLoader instanceof ResourcePatternResolver) {
        Resource[] resources = ((ResourcePatternResolver)resourceLoader).getResources(location); // â† è§¦å‘ Resource è§£æ
        ...
    }
}
```

- **æ ¸å¿ƒè§¦å‘ç‚¹**ï¼š`resourceLoader.getResources(location)`
- `resourceLoader` æ˜¯é€šè¿‡ `XmlBeanDefinitionReader.setResourceLoader(this)` è®¾ç½®çš„
  - `this` = `FileSystemXmlApplicationContext`
  - å®ƒç»§æ‰¿äº† `AbstractApplicationContext` â†’ å®ç°äº† `ResourcePatternResolver`

------

### 3.4 AbstractApplicationContext.getResources

```java
public Resource[] getResources(String locationPattern) throws IOException {
    return this.resourcePatternResolver.getResources(locationPattern);
}
```

- `resourcePatternResolver` é»˜è®¤æ˜¯ï¼š

```java
this.resourcePatternResolver = new PathMatchingResourcePatternResolver(this);
```

- **ä½œç”¨**ï¼šå¤„ç†é€šé…ç¬¦ï¼ˆå¦‚ `classpath*:*.xml`ï¼‰
- å¯¹äºå•ä¸€èµ„æºï¼ˆHTTP URL æˆ–æ–‡ä»¶è·¯å¾„ï¼‰ï¼Œä¼šè°ƒç”¨ï¼š

```java
getResourceLoader().getResource(location)
```

- è¿™é‡Œçš„ `getResourceLoader()` â†’ `this`ï¼ˆFileSystemXmlApplicationContext â†’ DefaultResourceLoaderï¼‰

------

### 3.5 PathMatchingResourcePatternResolver â†’ DefaultResourceLoader

æœ€ç»ˆè§£æé€»è¾‘åœ¨ `DefaultResourceLoader`ï¼š

```java
public Resource getResource(String location) {
    if (location.startsWith("/")) {
        return getResourceByPath(location);
    } else if (location.startsWith("classpath:")) {
        return new ClassPathResource(...);
    } else {
        try {
            URL url = new URL(location);
            return new UrlResource(url);  // â† è¿œç¨‹ URL
        } catch (MalformedURLException ex) {
            return getResourceByPath(location);
        }
    }
}
```

- `http://` â†’ åˆ›å»º `UrlResource` â†’ æ‰“å¼€ URL æµ
- `classpath:` â†’ åˆ›å»º `ClassPathResource` â†’ è¯»å– classpath
- æ–‡ä»¶è·¯å¾„ â†’ `FileSystemResource` â†’ è¯»å–æœ¬åœ°æ–‡ä»¶

------

### 3.6 XmlBeanDefinitionReader è§£æ XML

- `XmlBeanDefinitionReader.loadBeanDefinitions(Resource...)`
- è§£æ `<bean>` å…ƒç´  â†’ è°ƒç”¨æ„é€ å‡½æ•°/å·¥å‚æ–¹æ³• â†’ æ³¨å†Œåˆ° BeanFactory
- æ”»å‡»è€…å¯ä»¥åœ¨ XML é‡Œå®šä¹‰ **ä»»æ„ç±» + å±æ€§æ³¨å…¥**ï¼Œè§¦å‘ RCE

------

## 4ï¸âƒ£ å…¨é“¾è·¯æ€»ç»“

```pgsql
FileSystemXmlApplicationContext(configLocations)
    â†“
refresh()
    â†“
AbstractApplicationContext.obtainFreshBeanFactory()
	â†“
AbstractApplicationContext.refreshBeanFactory()
	â†“
AbstractRefreshableApplicationContext.refreshBeanFactory()
	â†“
AbstractRefreshableApplicationContext.loadBeanDefinitions(DefaultListableBeanFactory beanFactory)
	â†“
AbstractXmlApplicationContext.loadBeanDefinitions(DefaultListableBeanFactory beanFactory)
    â†“
AbstractXmlApplicationContext.loadBeanDefinitions(XmlBeanDefinitionReader reader)
	â†“
AbstractBeanDefinitionReader.loadBeanDefinitions(XmlBeanDefinitionReader reader)
	â†“
AbstractApplicationContext.getResources()
	â†“
PathMatchingResourcePatternResolver.getResources(String locationPattern)
	â†“
DefaultResourceLoader.getResource(String location) // FileSystemXmlApplicationContext å®ä¾‹
    â†“
AbstractApplicationContext.getResources(locationPattern)
    â†“
PathMatchingResourcePatternResolver.getResources(locationPattern)
    â†“
DefaultResourceLoader.getResource(location)   â† æœ€ç»ˆè§£æ URL/è·¯å¾„
    â†“
XmlBeanDefinitionReader.doLoadBeanDefinitions(InputSource)  // è§£æ XML
    â†“
Bean å®ä¾‹åŒ– â†’ å±æ€§æ³¨å…¥ â†’ RCE
```

------

## 5ï¸âƒ£ çŸ¥è¯†ç‚¹æ€»ç»“

1. **ç»§æ‰¿ä¸æ–¹æ³•è°ƒç”¨**
   - `this.setConfigLocations()` â†’ çˆ¶ç±»æ–¹æ³•
   - `this.refresh()` â†’ é«˜å±‚çˆ¶ç±»æ–¹æ³•
   - **å¤šæ€åŠ¨æ€ç»‘å®š**ï¼šæ–¹æ³•è°ƒç”¨çš„è¿è¡Œæ—¶å¯¹è±¡æ˜¯ `FileSystemXmlApplicationContext`
2. **ResourceLoader åŸç†**
   - `FileSystemXmlApplicationContext` ç»§æ‰¿ `DefaultResourceLoader`
   - `PathMatchingResourcePatternResolver` æ”¯æŒé€šé…ç¬¦ï¼Œå¹¶å§”æ‰˜ `getResource()`
   - **æœ€ç»ˆè§£æ URL** çš„åœ°æ–¹åœ¨ `DefaultResourceLoader.getResource()`
3. **XML è§£ææœºåˆ¶**
   - `XmlBeanDefinitionReader` å®ç°äº† `loadBeanDefinitions(Resource...)`
   - å°† XML è§£æä¸º BeanDefinition â†’ å®ä¾‹åŒ– Bean â†’ å¯èƒ½æ‰§è¡Œæ„é€ æ–¹æ³•æˆ–é™æ€æ–¹æ³•
4. **åˆ©ç”¨ç‚¹**
   - å¯æ§ `configLocations` â†’ è¿œç¨‹ XML URL â†’ ä»»æ„ Bean å®ä¾‹åŒ– â†’ RCE



## 6ï¸âƒ£ éšåç¬”è®°

```java
public void refresh() throws BeansException {
    // 1. åˆ›å»º BeanFactory å¹¶åŠ è½½ BeanDefinitionï¼ˆåªæ˜¯è§£æ XMLï¼Œæ”¾åˆ°å†…å­˜ä¸­ï¼‰
    ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();

    // 2. å‡†å¤‡ BeanFactoryï¼ˆè®¾ç½®ç±»åŠ è½½å™¨ã€PostProcessor ç­‰ï¼‰
    prepareBeanFactory(beanFactory);

    // 3. è°ƒç”¨ BeanFactoryPostProcessor ï¼ˆå¯¹ BeanDefinition åšä¿®æ”¹ï¼‰
    invokeBeanFactoryPostProcessors(beanFactory);

    // 4. æ³¨å†Œ BeanPostProcessorï¼ˆå®ä¾‹åŒ–å‰åå›è°ƒï¼‰
    registerBeanPostProcessors(beanFactory);

    // 5. åˆå§‹åŒ– MessageSource ç­‰å›½é™…åŒ–ç»„ä»¶
    initMessageSource();

    // 6. åˆå§‹åŒ–äº‹ä»¶å¹¿æ’­å™¨
    initApplicationEventMulticaster();

    // 7. æ³¨å†Œç›‘å¬å™¨
    registerListeners();

    // 8. **å®ä¾‹åŒ–å‰©ä½™çš„ï¼ˆéæ‡’åŠ è½½çš„ï¼‰å•ä¾‹ Bean**
    finishBeanFactoryInitialization(beanFactory);

    // 9. å®Œæˆåˆ·æ–°ï¼Œå‘å¸ƒäº‹ä»¶
    finishRefresh();
}
```

